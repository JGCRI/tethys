

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>User Guide &mdash; tethys 2.0.0 documentation</title>
  

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/panels-bootstrap.5fd3999ee7762ccc51105388f4a9d115.css" type="text/css" />
  <link rel="stylesheet" href="_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" type="text/css" />
  <link rel="stylesheet" href="_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" type="text/css" />
  <link rel="stylesheet" href="_static/css/tethys.css" type="text/css" />
  <link rel="stylesheet" href="_static/css/getting_started.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="API reference" href="modules.html" />
    <link rel="prev" title="Getting Started" href="getting_started.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home"> tethys
          

          
          </a>

          
            
            
              <div class="version">
                2.0.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="getting_started.html">Getting Started</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">User Guide</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#conceptual-overview">Conceptual Overview</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#spatial-downscaling">Spatial Downscaling</a></li>
<li class="toctree-l3"><a class="reference internal" href="#temporal-downscaling">Temporal Downscaling</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#domestic-municipal">Domestic/Municipal</a></li>
<li class="toctree-l4"><a class="reference internal" href="#electricity-generation">Electricity Generation</a></li>
<li class="toctree-l4"><a class="reference internal" href="#irrigation">Irrigation</a></li>
<li class="toctree-l4"><a class="reference internal" href="#other">Other</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#configuration-file">Configuration File</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#years">years</a></li>
<li class="toctree-l3"><a class="reference internal" href="#resolution">resolution</a></li>
<li class="toctree-l3"><a class="reference internal" href="#demand-type">demand_type</a></li>
<li class="toctree-l3"><a class="reference internal" href="#perform-temporal">perform_temporal</a></li>
<li class="toctree-l3"><a class="reference internal" href="#gcam-db">gcam_db</a></li>
<li class="toctree-l3"><a class="reference internal" href="#csv">csv</a></li>
<li class="toctree-l3"><a class="reference internal" href="#output-file">output_file</a></li>
<li class="toctree-l3"><a class="reference internal" href="#compress-outputs">compress_outputs</a></li>
<li class="toctree-l3"><a class="reference internal" href="#downscaling-rules">downscaling_rules</a></li>
<li class="toctree-l3"><a class="reference internal" href="#proxy-files">proxy_files</a></li>
<li class="toctree-l3"><a class="reference internal" href="#map-files">map_files</a></li>
<li class="toctree-l3"><a class="reference internal" href="#temporal-files">temporal_files</a></li>
<li class="toctree-l3"><a class="reference internal" href="#temporal-methods">temporal_methods</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#generalization">Generalization</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#spatial-modifications">Spatial Modifications</a></li>
<li class="toctree-l3"><a class="reference internal" href="#temporal-modifications">Temporal Modifications</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="modules.html">API reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="contributing.html">Contributing to <strong>tethys</strong></a></li>
<li class="toctree-l1"><a class="reference internal" href="license.html">License</a></li>
<li class="toctree-l1"><a class="reference internal" href="footer.html">Acknowledgement</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">tethys</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>User Guide</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="_sources/user_guide.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="user-guide">
<h1>User Guide<a class="headerlink" href="#user-guide" title="Permalink to this headline">¶</a></h1>
<p>This page provides an in-depth guide to <strong>tethys</strong>, covering details of the downscaling methodology and advanced usage.</p>
<p>Version 2 is a major update with increased flexibilty for spatial resolutions and sectoral breakdowns.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This page is currently under construction in preparation for version 2</p>
</div>
<div class="section" id="conceptual-overview">
<h2>Conceptual Overview<a class="headerlink" href="#conceptual-overview" title="Permalink to this headline">¶</a></h2>
<p><strong>tethys</strong> consists of 2 stages: spatial downscaling and (optionally) temporal downscaling.</p>
<div class="align-center figure">
<a class="reference internal image-reference" href="_images/overview.png"><img alt="overview" src="_images/overview.png" style="width: 50%;" /></a>
</div>
<div class="section" id="spatial-downscaling">
<h3>Spatial Downscaling<a class="headerlink" href="#spatial-downscaling" title="Permalink to this headline">¶</a></h3>
<p>For each water demand sector, <strong>tethys</strong> disaggregates water demand <em>by region</em> into water demand <em>by grid cell</em> based on an appropriate spatial proxy. GCAM uses 6 water demand sectors, and past downscaling workflows have used the following proxy configuration:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 59%" />
<col style="width: 41%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Water Demand Sector</p></th>
<th class="head"><p>Spatial Proxy</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Domestic/Municipal</p></td>
<td><p>Population</p></td>
</tr>
<tr class="row-odd"><td><p>Electricity Generation</p></td>
<td><p>Population</p></td>
</tr>
<tr class="row-even"><td><p>Manufacturing</p></td>
<td><p>Population</p></td>
</tr>
<tr class="row-odd"><td><p>Mining</p></td>
<td><p>Population</p></td>
</tr>
<tr class="row-even"><td><p>Livestock</p></td>
<td><p>Livestock</p></td>
</tr>
<tr class="row-odd"><td><p>Irrigation</p></td>
<td><p>Irrigated area</p></td>
</tr>
</tbody>
</table>
<p>Within a region, it is assumed that the distribution of water demand is proportional to the distribution of the proxy. For example, a grid cell that is part of the USA region and contains 1% of the USA’s population would be allocated 1% of the USA’s municipal water demand.</p>
<div class="math">
<p><img src="_images/math/7f3d7dcbcb3d328461d4076ba04e4bbc2bd2b17e.png" alt="\text{demand}_\text{cell} = \text{demand}_\text{region} \times \frac{\text{proxy}_\text{cell}}{\text{proxy}_\text{region}}"/></p>
</div><p>A sector may consist of multiple subsectors. For example, in GCAM, the livestock sector is split into 5 categories of animal products. Additionally, available proxy datasets may not map directly to these subsectors. <strong>tethys</strong> accounts for this by allowing user-defined mappings of water demand subsectors to proxy variables. The table below shows an example mapping between GCAM livestock subsectors and animal categories in the <a class="reference external" href="https://doi.org/10.1038/sdata.2018.227">GLW 3</a> dataset.</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 54%" />
<col style="width: 46%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Livestock Subsector</p></th>
<th class="head"><p>Spatial Proxy</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Beef</p></td>
<td><p>Buffalo + Cattle</p></td>
</tr>
<tr class="row-odd"><td><p>Dairy</p></td>
<td><p>Buffalo + Cattle</p></td>
</tr>
<tr class="row-even"><td><p>Pork</p></td>
<td><p>Pig</p></td>
</tr>
<tr class="row-odd"><td><p>Poultry</p></td>
<td><p>Chicken + Duck</p></td>
</tr>
<tr class="row-even"><td><p>SheepGoat</p></td>
<td><p>Sheep + Goat</p></td>
</tr>
</tbody>
</table>
<p>Subsectoral water demand estimates are sometimes only available at a coarser scale than estimates for the entire sector. This is the case for GCAM-USA, which only has water demand for each livestock subsector at the scale of the entire USA, while each state only has total demand for the entire livestock sector. <strong>tethys</strong> handles this by first downscaling each subsector using the specified proxy as usual, then harmonizing the result so that the total is consistent with the finer-scale constraint on the entire sector.</p>
<p>Since proxy datasets are not always available at the same spatial resolution as the desired output, <strong>tethys</strong> automatically re-grids proxies prior to downscaling. <strong>tethys</strong> also temporally interpolates proxies to the same years as the input demand data.</p>
</div>
<div class="section" id="temporal-downscaling">
<h3>Temporal Downscaling<a class="headerlink" href="#temporal-downscaling" title="Permalink to this headline">¶</a></h3>
<p><strong>tethys</strong> uses sector-specific formulas from the literature for temporal downscaling, which are described in detail below. In general, these determine the fraction of a year’s water demand to allocate to each month based on a statistical relationship between monthly water demand and some other monthly variable. When necessary, outputs from spatial downscaling are interpolated to annual time steps as an intermediate step.</p>
<div class="section" id="domestic-municipal">
<h4>Domestic/Municipal<a class="headerlink" href="#domestic-municipal" title="Permalink to this headline">¶</a></h4>
<p>Temporal downscaling for the domestic/municipal sector follows the formula from <a class="reference external" href="https://doi.org/10.1029/2010WR009792">Wada et al. (2011)</a>, which uses monthly temperature and a regional amplitude coefficient to reproduce summer peaks. For each grid cell,</p>
<div class="math">
<p><img src="_images/math/f5fd5b2e598ae25681bcc3f635979efe215621e0.png" alt="\frac{\text{demand}_\text{year}}{12} \times \left(\frac{\text{temp}_\text{month} - \text{temp}_\text{mean}}{\text{temp}_\text{max} - \text{temp}_\text{min}}R_\text{cell} + 1\right)"/></p>
</div></div>
<div class="section" id="electricity-generation">
<h4>Electricity Generation<a class="headerlink" href="#electricity-generation" title="Permalink to this headline">¶</a></h4>
<p>Temporal downscaling for the electricity generation sector follows the formula from <a class="reference external" href="https://doi.org/10.5194/hess-17-4555-2013">Voisin et al. (2013)</a>, which assumes that monthly water demand is proportional to monthly electricity demand, which in turn depends on heating and cooling degree days (HDD and CDD). HDD for a month or year is defined as the sum of <img class="math" src="_images/math/c3fd129ccb91dddf2febb537672a6cba2c508d9c.png" alt="(\text{temperature}_\text{day} - 18^{\circ}\text{C})"/> across all days in the time period, while CDD is the sum of <img class="math" src="_images/math/1b009ec8ab88434f310942a420f34139f3c6d9c4.png" alt="(18^{\circ}\text{C} - \text{temperature}_\text{day})"/>. For grid cells where annual HDD &gt; 450 and CDD &gt; 650,</p>
<div class="math">
<p><img src="_images/math/27f1608c048c821e56777cc34ce509fc07ab3f0b.png" alt="\text{demand}_\text{month} = \text{demand}_\text{year} \times \left( p_\text{heating}\frac{\text{HDD}_\text{month}}{\text{HDD}_\text{year}} + p_\text{cooling}\frac{\text{CDD}_\text{month}}{\text{CDD}_\text{year}} + p_\text{other}\frac{1}{12} \right),"/></p>
</div><p>where <img class="math" src="_images/math/8c2c50fabb2fc56ca95ca6f642053fe1a23729ba.png" alt="p_\text{heating}"/> is the share of the region’s annual electricity consumption used for heating buildings, <img class="math" src="_images/math/c964bc635f0fb1ba48278da9fe4a61ee7f5c150c.png" alt="p_\text{cooling}"/> is the share used for cooling buildings, and <img class="math" src="_images/math/874ba0a694f653ebfd28816bd33542a7ced4f1a4.png" alt="p_\text{other}"/> the share for all other uses in buildings, as well as for industry and transportation. These proportions come from region-scale data, but there may be cells in a region that do not have heating or cooling infrastructure (for example, because it doesn’t usually get cold there), so this formula is modified for cells depending on annual HDD and CDD as described in <a class="reference external" href="https://doi.org/10.5194/hess-22-2117-2018">Huang et al. (2018)</a>. When HDD &gt; 450, but CDD &lt; 650,</p>
<div class="math">
<p><img src="_images/math/11cbac5c8ff1cfaeeb4662534d459ef44358ded2.png" alt="\text{demand}_\text{month} = \text{demand}_\text{year} \times \left( (p_\text{heating} + p_\text{cooling} )\frac{\text{HDD}_\text{month}}{\text{HDD}_\text{year}} + p_\text{other}\frac{1}{12} \right)."/></p>
</div><p>Similarly, when CDD &gt; 650, but HDD &lt; 450</p>
<div class="math">
<p><img src="_images/math/ecfbfeab5b196f2c050bdf4e9fc7ce629b9d0926.png" alt="\text{demand}_\text{month} = \text{demand}_\text{year} \times \left( (p_\text{cooling} + p_\text{heating} )\frac{\text{CDD}_\text{month}}{\text{CDD}_\text{year}} + p_\text{other}\frac{1}{12} \right)."/></p>
</div><p>When both HDD &lt; 450 and CDD &lt; 650, all sources of monthly variation vanish, leaving</p>
<div class="math">
<p><img src="_images/math/3a479388d3bd37ca0407ac280fa813ec00d25920.png" alt="\text{demand}_\text{month} = \text{demand}_\text{year} \times \frac{1}{12}."/></p>
</div></div>
<div class="section" id="irrigation">
<h4>Irrigation<a class="headerlink" href="#irrigation" title="Permalink to this headline">¶</a></h4>
<p>Temporal downscaling for the irrigation sector is based on monthly irrigation profiles calculated from exogenous crop water models. Users supply monthly gridded irrigation data from a model of their choice, which is then averaged over the region-basin, and applied as follows:</p>
<div class="math">
<p><img src="_images/math/15d9d4a7dcefcf034a6e4a58cbe63f63d2133b7a.png" alt="\text{demand}_\text{month} = \text{demand}_\text{year} \times \frac{\text{irrigation}_\text{month}}{\text{irrigation}_\text{year}}."/></p>
</div></div>
<div class="section" id="other">
<h4>Other<a class="headerlink" href="#other" title="Permalink to this headline">¶</a></h4>
<p>Temoral downscaling of the livestock, manufacturing, and mining sectors assumes that monthly water demand is uniform, following Wada et al. (2011).</p>
<div class="math">
<p><img src="_images/math/11fb48bafa0ea3bc25f47c7c3b610baa4dceaaa6.png" alt="\text{demand}_\text{month} = \text{demand}_\text{year} \times \frac{1}{12}"/></p>
</div><p>As new methods are developed for temporally downscaling these sectors, they will be added.</p>
</div>
</div>
</div>
<div class="section" id="configuration-file">
<h2>Configuration File<a class="headerlink" href="#configuration-file" title="Permalink to this headline">¶</a></h2>
<p><strong>tethys</strong> uses a <a class="reference external" href="https://yaml.org/spec/1.2.2/">YAML</a> configuration file. The options in this file correspond to the arguments passed to the <a class="reference internal" href="tethys.html#module-tethys.model"><span class="std std-ref">Tethys class</span></a>. Options not present in the config file will use the default. An overview is provided in the following table, with more details and examples below.</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 30%" />
<col style="width: 70%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Option</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><a class="reference internal" href="#years"><span class="std std-ref">years</span></a></p></td>
<td><p>list of years to be included spatial downscaling</p></td>
</tr>
<tr class="row-odd"><td><p><a class="reference internal" href="#resolution"><span class="std std-ref">resolution</span></a></p></td>
<td><p>resolution in degrees for spatial downscaling</p></td>
</tr>
<tr class="row-even"><td><p><a class="reference internal" href="#demand-type"><span class="std std-ref">demand_type</span></a></p></td>
<td><p>choice between “withdrawals” (default) or “consumption”</p></td>
</tr>
<tr class="row-odd"><td><p><a class="reference internal" href="#perform-temporal"><span class="std std-ref">perform_temporal</span></a></p></td>
<td><p>choice between “false” (default) or “true”</p></td>
</tr>
<tr class="row-even"><td><p><a class="reference internal" href="#gcam-db"><span class="std std-ref">gcam_db</span></a></p></td>
<td><p>relative path to a GCAM database</p></td>
</tr>
<tr class="row-odd"><td><p><a class="reference internal" href="#csv"><span class="std std-ref">csv</span></a></p></td>
<td><p>relative path to csv file containing inputs</p></td>
</tr>
<tr class="row-even"><td><p><a class="reference internal" href="#output-file"><span class="std std-ref">output_file</span></a></p></td>
<td><p>name of file to write outputs to</p></td>
</tr>
<tr class="row-odd"><td><p><a class="reference internal" href="#compress-outputs"><span class="std std-ref">compress_outputs</span></a></p></td>
<td><p>choice between “true” (default) or “false”</p></td>
</tr>
<tr class="row-even"><td><p><a class="reference internal" href="#downscaling-rules"><span class="std std-ref">downscaling_rules</span></a></p></td>
<td><p>see details</p></td>
</tr>
<tr class="row-odd"><td><p><a class="reference internal" href="#proxy-files"><span class="std std-ref">proxy_files</span></a></p></td>
<td><p>see details</p></td>
</tr>
<tr class="row-even"><td><p><a class="reference internal" href="#map-files"><span class="std std-ref">map_files</span></a></p></td>
<td><p>see details</p></td>
</tr>
<tr class="row-odd"><td><p><a class="reference internal" href="#temporal-files"><span class="std std-ref">temporal_files</span></a></p></td>
<td><p>see details</p></td>
</tr>
<tr class="row-even"><td><p><a class="reference internal" href="#temporal-methods"><span class="std std-ref">temporal_methods</span></a></p></td>
<td><p>see details</p></td>
</tr>
</tbody>
</table>
<div class="section" id="years">
<h3>years<a class="headerlink" href="#years" title="Permalink to this headline">¶</a></h3>
<p>List of years for spatial downscaling. Region-scale input demands will be filtered to these years. Proxy data will be linearly interpolated to the years on this list (except for years outside the endpoints of the proxy data, which will use the nearest endpoint).</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">years</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">2010</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">2015</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">2020</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">2025</span><span class="p p-Indicator">]</span>
</pre></div>
</div>
</div>
<div class="section" id="resolution">
<h3>resolution<a class="headerlink" href="#resolution" title="Permalink to this headline">¶</a></h3>
<p>Output resolution in degrees for spatial downscaling. Proxies will be regridded to this resolution.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">resolution</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.125</span>
</pre></div>
</div>
</div>
<div class="section" id="demand-type">
<h3>demand_type<a class="headerlink" href="#demand-type" title="Permalink to this headline">¶</a></h3>
<p>Whether the demands are water withdrawals or conusmption. Default is withdrawals. This option determines what values will be checked in the GCAM database if used, and will be passed along to the outputs.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">demand_type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">consumption</span>
</pre></div>
</div>
</div>
<div class="section" id="perform-temporal">
<h3>perform_temporal<a class="headerlink" href="#perform-temporal" title="Permalink to this headline">¶</a></h3>
<p>Whether to perform temporal downscaling or not. Default is false.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">perform_temporal</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</pre></div>
</div>
</div>
<div class="section" id="gcam-db">
<h3>gcam_db<a class="headerlink" href="#gcam-db" title="Permalink to this headline">¶</a></h3>
<p>Path to a GCAM database (the folder containing a bunch of <em>.basex</em> files).</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">gcam_db</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">data/GCAM_databases/my_GCAM_db</span>
</pre></div>
</div>
</div>
<div class="section" id="csv">
<h3>csv<a class="headerlink" href="#csv" title="Permalink to this headline">¶</a></h3>
<p>As an alternative to <code class="docutils literal notranslate"><span class="pre">gcam_db</span></code>, path to a csv file containing region-scale water demand inputs. The file should have the following columns: region, sector, year, and value.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">csv</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">data/example_input.csv</span>
</pre></div>
</div>
</div>
<div class="section" id="output-file">
<h3>output_file<a class="headerlink" href="#output-file" title="Permalink to this headline">¶</a></h3>
<p>Filepath in which outputs will be written. If none (default), outputs will not be saved, but they can be interacted with in-memory via the outputs attribute of the Tethys class. If the path is not absolute, it will be relative to the directory containing the config file. This file will be overwritten if it exist already and created if it doesn’t, but the directory containing it must already exist.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">output_file</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">outputs/tethys_outputs.nc</span><span class="w">  </span><span class="c1"># the folder &quot;&lt;config_file_dir&gt;/outputs&quot; must already exist</span>
</pre></div>
</div>
</div>
<div class="section" id="compress-outputs">
<h3>compress_outputs<a class="headerlink" href="#compress-outputs" title="Permalink to this headline">¶</a></h3>
<p>Whether or not to compress the outputs. Defaults to true. This will use zlib level 5, but you can have more customization over this by interacting directly with the outputs attribute of the Tethys class.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">compress_outputs</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span><span class="w">  </span><span class="c1"># because we want our outputs files to be really big for some reason</span>
</pre></div>
</div>
</div>
<div class="section" id="downscaling-rules">
<h3>downscaling_rules<a class="headerlink" href="#downscaling-rules" title="Permalink to this headline">¶</a></h3>
<p>A mapping between water demand sectors and proxy variables. The simplest kind of entry is of the form <code class="docutils literal notranslate"><span class="pre">sector:</span> <span class="pre">proxy</span></code>, like for the Municipal sector in the example below. The proxy can optionally be a list of variables that will be added together first. When a sector is composed of multiple subsectors, a second layer of mappings is allowed (as with Livestock in the example below). If the total sector has a total demand at a finer regional resolution (e.g., GCAM-USA livestock), that will be applied as a constraint on the total after downscaling by subsector at coarser regional resolution.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">downscaling_rules</span><span class="p">:</span>
<span class="w">  </span><span class="nt">Municipal</span><span class="p">:</span><span class="w">   </span><span class="l l-Scalar l-Scalar-Plain">Population</span>
<span class="w">  </span><span class="nt">Livestock</span><span class="p">:</span>
<span class="w">    </span><span class="nt">Beef</span><span class="p">:</span><span class="w">      </span><span class="p p-Indicator">[</span><span class="nv">Buffalo</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">Cattle</span><span class="p p-Indicator">]</span>
<span class="w">    </span><span class="nt">Dairy</span><span class="p">:</span><span class="w">     </span><span class="p p-Indicator">[</span><span class="nv">Buffalo</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">Cattle</span><span class="p p-Indicator">]</span>
<span class="w">    </span><span class="nt">Pork</span><span class="p">:</span><span class="w">      </span><span class="l l-Scalar l-Scalar-Plain">Pig</span>
<span class="w">    </span><span class="nt">Poultry</span><span class="p">:</span><span class="w">   </span><span class="p p-Indicator">[</span><span class="nv">Chicken</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">Duck</span><span class="p p-Indicator">]</span>
<span class="w">    </span><span class="nt">SheepGoat</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">Sheep</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">Goat</span><span class="p p-Indicator">]</span>
</pre></div>
</div>
</div>
<div class="section" id="proxy-files">
<h3>proxy_files<a class="headerlink" href="#proxy-files" title="Permalink to this headline">¶</a></h3>
<p>A mapping of file paths (absolute, or relative to the config file) to the proxy variables and years they contain, as well as any flags needed to interpret them. The entries are of the form</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">filepath</span><span class="p">:</span>
<span class="w">  </span><span class="nt">variables</span><span class="p">:</span><span class="w">  </span><span class="c1"># variable or list of variables in the file</span>
<span class="w">  </span><span class="nt">years</span><span class="p">:</span><span class="w">  </span><span class="c1"># year or list of years in the file</span>
<span class="w">  </span><span class="nt">flags</span><span class="p">:</span><span class="w">  </span><span class="c1"># flag or list of flags to help interpret the file (optional)</span>
</pre></div>
</div>
<p>Flags understood are ‘cell_area_share’, and ‘short_name_as_name’. ‘cell_area_share’ means that the grid cell values in the file correspond to the share of that cell covered by the variable, so <strong>tethys</strong> multiplies by the area of the cell to obtain a quantity that can be used as a proxy. ‘short_name_as_name’ is for netCDF files where <code class="docutils literal notranslate"><span class="pre">variables</span></code> corresponds to the ‘short_name’ attribute, not the variable name.</p>
<p>For files systematically named by variable and/or year, the file path can contain <code class="docutils literal notranslate"><span class="pre">{variable}</span></code> and <code class="docutils literal notranslate"><span class="pre">{year}</span></code>, and the corresponding values will be substituted. If the files use abbreviated names, then <code class="docutils literal notranslate"><span class="pre">variables</span></code> can be a mapping of <code class="docutils literal notranslate"><span class="pre">variable:</span> <span class="pre">abbreviation</span></code> pairs.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">proxy_files</span><span class="p">:</span>

<span class="w">  </span><span class="c1"># 4 files, each containing Population data for a single year</span>
<span class="w">  </span><span class="l l-Scalar l-Scalar-Plain">data/population/ssp1_{year}.tif</span><span class="p p-Indicator">:</span>
<span class="w">    </span><span class="nt">variables</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Population</span>
<span class="w">    </span><span class="nt">years</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">2010</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">2020</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">2030</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">2040</span><span class="p p-Indicator">]</span>

<span class="w">  </span><span class="c1"># 7 files, each containing data for a single animal in 2010</span>
<span class="w">  </span><span class="c1"># files are named using abbreviations like &#39;5_Bf_2010_Da.tif&#39;,</span>
<span class="w">  </span><span class="c1"># but we refer to the variable with the full name like &#39;Buffalo&#39;</span>
<span class="w">  </span><span class="l l-Scalar l-Scalar-Plain">data/GLW3/5_{variable}_2010_Da.tif</span><span class="p p-Indicator">:</span>
<span class="w">    </span><span class="nt">variables</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{</span><span class="nt">Buffalo</span><span class="p">:</span><span class="w"> </span><span class="nv">Bf</span><span class="p p-Indicator">,</span><span class="nt"> Cattle</span><span class="p">:</span><span class="w"> </span><span class="nv">Ct</span><span class="p p-Indicator">,</span><span class="nt"> Sheep</span><span class="p">:</span><span class="w"> </span><span class="nv">Sh</span><span class="p p-Indicator">,</span><span class="nt"> Goat</span><span class="p">:</span><span class="w"> </span><span class="nv">Gt</span><span class="p p-Indicator">,</span><span class="nt"> Chicken</span><span class="p">:</span><span class="w"> </span><span class="nv">Ch</span><span class="p p-Indicator">,</span><span class="nt"> Duck</span><span class="p">:</span><span class="w"> </span><span class="nv">Dk</span><span class="p p-Indicator">,</span><span class="nt"> Pig</span><span class="p">:</span><span class="w"> </span><span class="nv">Pg</span><span class="p p-Indicator">}</span>
<span class="w">    </span><span class="nt">years</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2010</span>

<span class="w">  </span><span class="c1"># 6 files, each containing multiple variables for a single year</span>
<span class="w">  </span><span class="c1"># the variables represent the share of area in the grid cell, not the total area</span>
<span class="w">  </span><span class="c1"># we only extract the variables whose netCDF short_name is in the list</span>
<span class="w">  </span><span class="l l-Scalar l-Scalar-Plain">data/Demeter/ssp1_rcp26_gfdl_{year}.nc</span><span class="p p-Indicator">:</span>
<span class="w">    </span><span class="nt">flags</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">cell_area_share</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">short_name_as_name</span><span class="p p-Indicator">]</span>
<span class="w">    </span><span class="nt">variables</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">Corn_irr</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">Cotton_irr</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">OtherCrop_irr</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">Soy_irr</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">Rice_irr</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">Sugarcrop_irr</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">Wheat_irr</span><span class="p p-Indicator">]</span>
<span class="w">    </span><span class="nt">years</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">2005</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">2010</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">2015</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">2020</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">2025</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">2030</span><span class="p p-Indicator">]</span>
</pre></div>
</div>
</div>
<div class="section" id="map-files">
<h3>map_files<a class="headerlink" href="#map-files" title="Permalink to this headline">¶</a></h3>
<p>List of paths to map files. These should be geotiffs with an attribute called ‘names’ containing a mapping of names to region numbers. 0 is reserved for nonland/ignored regions.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">map_files</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">data/maps/regions.tif</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">data/maps/regionbasins.tif</span><span class="p p-Indicator">]</span>
</pre></div>
</div>
</div>
<div class="section" id="temporal-files">
<h3>temporal_files<a class="headerlink" href="#temporal-files" title="Permalink to this headline">¶</a></h3>
<p>Mapping of files that will be accessible to temporal downscaling methods.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">temporal_files</span><span class="p">:</span>
<span class="w">  </span><span class="nt">HDD</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">data/temporal/HDD_monthly.nc</span>
<span class="w">  </span><span class="nt">CDD</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">data/temporal/CDD_monthly.nc</span>
</pre></div>
</div>
</div>
<div class="section" id="temporal-methods">
<h3>temporal_methods<a class="headerlink" href="#temporal-methods" title="Permalink to this headline">¶</a></h3>
<p>Mapping of sector name to downscaling method in the <em>tdmethods</em> module. If not specified, defaults for GCAM sectors are used. If specified, sectors in the mapping will use uniform downscaling as a fallback. See <a class="reference internal" href="#temporal-modifications"><span class="std std-ref">Temporal Modifications</span></a>.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">temporal_methods</span><span class="p">:</span>
<span class="w">  </span><span class="nt">Municipal</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">domestic</span>
<span class="w">  </span><span class="nt">Electricity</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">electricity</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="generalization">
<h2>Generalization<a class="headerlink" href="#generalization" title="Permalink to this headline">¶</a></h2>
<p><strong>tethys</strong> was developed with consideration for GCAM’s breakdown of water demand, but was designed to be as flexible as possible with support for user-specified downscaling configurations.</p>
<div class="section" id="spatial-modifications">
<h3>Spatial Modifications<a class="headerlink" href="#spatial-modifications" title="Permalink to this headline">¶</a></h3>
<p>Fundamentally, proxy-based spatial downscaling requires</p>
<ul class="simple">
<li><p>region-scale input data (to be downscaled)</p></li>
<li><p>gridded proxy data</p></li>
<li><p>a map defining what grid cells belong to each region</p></li>
</ul>
<p>The configuration file provides an <a class="reference internal" href="#downscaling-rules"><span class="std std-ref">interface</span></a> for describing the relationship between input sectors and proxy variables, which enables <strong>tethys</strong> to be compatible with versions of GCAM using different breakdowns of water demand (for example, different crop types), but also allows it to downscale water demand data from other models and sources. This flexibility makes it easy to run <strong>tethys</strong> with new input and proxy datasets as they become available.</p>
<p>Suppose we had region-scale Municipal water demand data by income decile, as well as Population datasets broken out similarly. Then this could be represented in the config file with something like</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">downscaling_rules</span><span class="p">:</span>
<span class="w">  </span><span class="nt">Municipal</span><span class="p">:</span>
<span class="w">    </span><span class="nt">Municipal_d1</span><span class="p">:</span><span class="w">  </span><span class="l l-Scalar l-Scalar-Plain">Population_d1</span>
<span class="w">    </span><span class="nt">Municipal_d2</span><span class="p">:</span><span class="w">  </span><span class="l l-Scalar l-Scalar-Plain">Population_d2</span>
<span class="w">    </span><span class="nt">Municipal_d3</span><span class="p">:</span><span class="w">  </span><span class="l l-Scalar l-Scalar-Plain">Population_d3</span>
<span class="w">    </span><span class="nt">Municipal_d4</span><span class="p">:</span><span class="w">  </span><span class="l l-Scalar l-Scalar-Plain">Population_d4</span>
<span class="w">    </span><span class="nt">Municipal_d5</span><span class="p">:</span><span class="w">  </span><span class="l l-Scalar l-Scalar-Plain">Population_d5</span>
<span class="w">    </span><span class="nt">Municipal_d6</span><span class="p">:</span><span class="w">  </span><span class="l l-Scalar l-Scalar-Plain">Population_d6</span>
<span class="w">    </span><span class="nt">Municipal_d7</span><span class="p">:</span><span class="w">  </span><span class="l l-Scalar l-Scalar-Plain">Population_d7</span>
<span class="w">    </span><span class="nt">Municipal_d8</span><span class="p">:</span><span class="w">  </span><span class="l l-Scalar l-Scalar-Plain">Population_d8</span>
<span class="w">    </span><span class="nt">Municipal_d9</span><span class="p">:</span><span class="w">  </span><span class="l l-Scalar l-Scalar-Plain">Population_d9</span>
<span class="w">    </span><span class="nt">Municipal_d10</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Population_d10</span>

<span class="nt">proxy_files</span><span class="p">:</span>
<span class="w">  </span><span class="l l-Scalar l-Scalar-Plain">data/Population/{variable}_{year}.tif</span><span class="p p-Indicator">:</span>
<span class="w">    </span><span class="nt">variables</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">Population_d1</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">Population_d2</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">Population_d3</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">Population_d4</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">Population_d5</span><span class="p p-Indicator">,</span>
<span class="w">                </span><span class="nv">Population_d6</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">Population_d7</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">Population_d8</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">Population_d9</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">Population_d10</span><span class="p p-Indicator">]</span>
<span class="w">    </span><span class="nt">years</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">2005</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">2010</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">2015</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">2020</span><span class="p p-Indicator">]</span>
</pre></div>
</div>
</div>
<div class="section" id="temporal-modifications">
<h3>Temporal Modifications<a class="headerlink" href="#temporal-modifications" title="Permalink to this headline">¶</a></h3>
<p><strong>tethys</strong> also has a mechanism for defining custom temporal downscaling rules. The <em>tdmethods</em> folder contains functions that take the <cite>Tethys</cite> object as argument and output a monthly distribution. You can add your own module that defines a <cite>temporal_distribution</cite> function, and then use the <cite>temporal_methods</cite> setting to indicate what method should be used for which sector.</p>
<p>As a simple example, suppose we wanted to define a rule that downscales water demand for manufacturing based on the number of days in a calendar month (ignoring leap years), as opposed to 12 equal segments of the year. We could write the following, say <em>daysinmonth.py</em></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># td_methods/daysinmonth.py</span>

<span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>


<span class="k">def</span> <span class="nf">temporal_distribution</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Temporal downscaling distribution based on days in calendar month&quot;&quot;&quot;</span>

  <span class="n">days_in_month</span> <span class="o">=</span> <span class="p">[</span><span class="mi">31</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">31</span><span class="p">]</span>
  <span class="n">distribution</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">days_in_month</span><span class="p">,</span> <span class="n">coords</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">month</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">13</span><span class="p">))</span> <span class="o">/</span> <span class="mi">365</span>

  <span class="k">return</span> <span class="n">distribution</span>
</pre></div>
</div>
<p>Then, in the configuration file:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">temporal_methods</span><span class="p">:</span>
<span class="w">  </span><span class="nt">Manufacturing</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">daysinmonth</span>
</pre></div>
</div>
<p>The custom function should be named ‘temporal_distribution’ and accept a <code class="docutils literal notranslate"><span class="pre">Tethys</span></code> object as its only argument. It should return an xarray DataArray with at least a dimension named ‘month’, but could be also have dimensions ‘year’, ‘lat’, and ‘lon’. The sums across the month axis should add to 1. The resulting distribution will be broadcast against the output from spatial downscaling.</p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="modules.html" class="btn btn-neutral float-right" title="API reference" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="getting_started.html" class="btn btn-neutral float-left" title="Getting Started" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2021, Battelle Memorial Institute.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>